<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>iOS学习笔记(27) iCloud(三) key-Value Stroe | 萧宸宇</title>
  <meta name="author" content="萧宸宇">
  
  <meta name="description" content="iOS,Cocoa,OS X,如果不能成为拯救世界的神，那就堕落到征服世界的魔吧。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="iOS学习笔记(27) iCloud(三) key-Value Stroe"/>
  <meta property="og:site_name" content="萧宸宇"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="萧宸宇" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-29764460-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">萧宸宇</a></h1>
  <h2><a href="/">如果不能成为拯救世界的神，那就堕落到征服世界的魔吧。</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/about-me">关于我</a></li>
    
      <li><a href="/atom.xml">RSS</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-09-02T14:21:13.000Z"><a href="/2013/09/02/learning-ios-notes-twenty-seven/">9月 2 2013</a></time>
      
      
  
    <h1 class="title">iOS学习笔记(27) iCloud(三) key-Value Stroe</h1>
  

    </header>
    <div class="entry">
      
        <h2>什么是NSUserDefaults</h2>
<p>NSUserDefaults的持久化本体是一个<a href="http://zh.wikipedia.org/zh/Plist" target="_blank">plist</a>.内存单例是一个操作类似NSDictionary的类。 而NSUserDefaults的出现我想是因为在每一个程序当中。我们都会设定一些选项。比如桌面壁纸、声音大小、提醒日期等，我们希望就算App关闭以后。我们再次打开的时候还在的东西。但是它并不适合存储App中关键的内容和用户自己产生的大量数据。 大量数据应该用更加合理的方式去做持久化(Document or Core Data).</p>
<a id="more"></a>

<h3>NSUserDefaults简单代码讲解</h3>
<p>使用NSUserDefaults其实巨简单。 </p>
<p>大概步骤如下:</p>
<ol>
<li>首先通过一个单例获得持久化plist的内存映射。</li>
<li>然后就可以用这个单例的实例类进行读写操作。</li>
<li>读当然没啥问题，但是写了的话这时候只是操作了在内存里面的这个单例实例。需要做持久化的动作。为什么这个动作要自己来做呢。我想是持久化都是进行IO操作。而IO操作其实很多时候就是性能的瓶颈所在。我们可能很短的时间内一次性操作很多次NSUserDefaults。这样就只用在结束的时候保存一次。IO操作就很少。反之如果每次写NSUserDefaults的时候都去做持久化。那刚刚的情况就会在很短的时间内操作多次IO。这是应该避免的。</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="comment">// 首先把数据从plist里面读到内存里面的单例来</span>
NSUserDefaults *standardDefaults = [NSUserDefaults standardUserDefaults];

<span class="comment">// 进行增加or修改操作</span>
[standardDefaults setObject:<span class="string">@"a123456789"</span> forKey:<span class="string">@"userID"</span>];
[standardDefaults setInteger:<span class="number">24</span> forKey:<span class="string">@"age"</span>];
[standardDefaults setBool:YES forKey:<span class="string">@"isLogin"</span>];

<span class="comment">// 删除操作</span>
[standardDefaults removeObjectForKey:<span class="string">@"debts"</span>];

<span class="comment">// 从内存里面写入plist进行持久化</span>
[standardDefaults synchronize];

<span class="comment">// 读取操作</span>
NSString *userID = [standardDefaults stringForKey:<span class="string">@"userID"</span>];
BOOL isLogin = [standardDefaults boolForKey:<span class="string">@"isLogin"</span>];
</pre></td></tr></table></figure>

<p>当然还有现代一点的写法。下面两种都是一个效果</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="comment">// 常见方法</span>
NSUserDefaults *standardDefaults = [NSUserDefaults standardUserDefaults];
<span class="keyword">if</span> ([standardDefaults stringForKey:<span class="string">@"favoriteColor"</span>] == nil) {
[standardDefaults setObject:<span class="string">@"Green"</span> forKey:<span class="string">@"favoriteColor"</span>];
[standardDefaults synchronize];
}

<span class="comment">// 现代高端上档次方法</span>
NSUserDefaults *standardDefaults = [NSUserDefaults standardUserDefaults];
[standardDefaults registerDefaults:@{<span class="string">@"favoriteColor"</span>: <span class="string">@"Green"</span>}];
[standardDefaults synchronize];
</pre></td></tr></table></figure>

<h2>iCloud的Key-Value</h2>
<p>简单的，可以把iCloud的key-value当作一个在云端的NSUserDefaults。</p>
<p>我的用法是，App的Setting最终设置决定的还是NSUserDefaults。iCloud的Key-Value作为数据源来对NSUserDefaults进行修改。这样的优点在于，就算iCloud关闭或者iCloud的数据没有同步回来。你的App依然可以正常的工作和运行。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="built_in">NSUserDefaults</span> *standardDefaults = [<span class="built_in">NSUserDefaults</span> standardUserDefaults];
</pre></td></tr></table></figure>

<p>对应</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>NSUbiquitousKeyValueStore* store = [NSUbiquitousKeyValueStore defaultStore]<span class="comment">;</span>
</pre></td></tr></table></figure>

<p>其他操作跟NSUserDefaults一样一样的。</p>
<p>只有一个值得注意的是NSUbiquitousKeyValueStore需要去监听<br>NSUbiquitousKeyValueStoreDidChangeExternallyNotification事件。就可以知道NSUbiquitousKeyValueStore是否已经同步更新完成。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre>NSUbiquitousKeyValueStore* store = [NSUbiquitousKeyValueStore defaultStore];
<span class="string">[[NSNotificationCenter defaultCenter] addObserver:self
          selector:@selector(updateKVStoreItems:)
          name:NSUbiquitousKeyValueStoreDidChangeExternallyNotification
          object:store];
[store synchronize];
</pre></td></tr></table></figure>

<p>然后实现updateKVStoreItems:方法</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="code"><pre>- (void)updateKVStoreItems:(NSNotification*)notification {
   // Get <span class="keyword">the</span> <span class="type">list</span> <span class="keyword">of</span> keys <span class="keyword">that</span> changed.
   NSDictionary* userInfo = [notification userInfo];
   NSNumber* reasonForChange = [userInfo objectForKey:NSUbiquitousKeyValueStoreChangeReasonKey];
   NSInteger reason = -<span class="number">1</span>;
 
   // If a reason could <span class="keyword">not</span> be determined, do <span class="keyword">not</span> update anything.
   <span class="keyword">if</span> (!reasonForChange)
<span class="command">      return</span>;
 
   // Update only <span class="keyword">for</span> changes <span class="keyword">from</span> <span class="keyword">the</span> server.
   reason = [reasonForChange integerValue];
   <span class="keyword">if</span> ((reason == NSUbiquitousKeyValueStoreServerChange) ||
         (reason == NSUbiquitousKeyValueStoreInitialSyncChange)) {
      // If something <span class="keyword">is</span> changing externally, <span class="keyword">get</span> <span class="keyword">the</span> changes
      // <span class="keyword">and</span> update <span class="keyword">the</span> corresponding keys locally.
      NSArray* changedKeys = [userInfo objectForKey:NSUbiquitousKeyValueStoreChangedKeysKey];
      NSUbiquitousKeyValueStore* store = [NSUbiquitousKeyValueStore defaultStore];
      NSUserDefaults* userDefaults = [NSUserDefaults standardUserDefaults];
 
      // This loop assumes you are using <span class="keyword">the</span> same key names <span class="keyword">in</span> both
      // <span class="keyword">the</span> user defaults database <span class="keyword">and</span> <span class="keyword">the</span> iCloud key-value store
      <span class="keyword">for</span> (NSString* key <span class="keyword">in</span> changedKeys) {
         <span class="property">id</span> value = [store objectForKey:key];
         [userDefaults setObject:value forKey:key];
      }
   }
}
</pre></td></tr></table></figure>

<p>超级简单吧。</p>
<h2>第三方库推荐</h2>
<p>当然有大神写的第三方库。并且实现了NSUserDefaults白名单功能。因为可能你存在NSUserDefaults里面的东西不想要也不需要全部同步到NSUbiquitousKeyValueStore上去把。</p>
<p>对了忘记说一点NSUbiquitousKeyValueStore可是有大小和条目限制的。你不要把他当作无穷无尽的东西来用。具体限制是最大空间1 MB。 最多1024个key。记住不要拿来当作主要数据存储哦。</p>
<p>MK大神应该还是如雷贯耳的把。 不知道么。 MKNetworkKit是他写的。还不知道么。<br><a href="http://www.amazon.com/gp/product/1118449959/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1118449959&amp;linkCode=as2&amp;tag=blogmugunthku-20" target="_blank">iOS 6 Programming Pushing the Limits: Advanced Application Development for Apple iPhone, iPad and iPod Touch</a> 可是他写的哦。我和我的小伙伴都从MK大神的书里面学到很多不错的东西</p>
<p><a href="https://github.com/MugunthKumar/MKiCloudSync" target="_blank">MKiCloudSync</a></p>
<p><a href="https://github.com/Daij-Djan/DDiCloudSync" target="_blank">DDiCloudSync</a></p>
<p><a href="https://github.com/futuretap/FTiCloudSync" target="_blank">FTiCloudSync</a></p>
<h2>总结</h2>
<p>参考资料：</p>
<p><a href="https://developer.apple.com/library/ios/documentation/cocoa/Conceptual/UserDefaults/Introduction/Introduction.html" target="_blank">Preferences and Settings Programming Guide</a></p>
<p><a href="http://gibuloto.com/blog/nsuserdefaults/" target="_blank">NSUserDefaults (plist) 筆記</a></p>
<p><a href="http://www.doubleencore.com/2013/03/back-to-basics-forgotten-nsuserdefaults/" target="_blank">Back to Basics: Forgotten NSUserDefaults</a></p>
<p><a href="http://www.techotopia.com/index.php/Synchronizing_iPhone_iOS_5_Key-Value_Data_using_iCloud" target="_blank">Synchronizing iPhone iOS 5 Key-Value Data using iCloud</a></p>
<p><a href="http://useyourloaf.com/blog/2011/10/24/sync-preference-data-with-icloud.html" target="_blank">Sync Preference Data With iCloud</a></p>
<p><a href="http://www.raywenderlich.com/6015/beginning-icloud-in-ios-5-tutorial-part-1" target="_blank">Beginning iCloud in iOS 5 Tutorial Part 1</a></p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/iOS/">iOS</a>
  </div>

        
        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:iiiyu.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Emacs/">Emacs</a><small>3</small></li>
  
    <li><a href="/categories/Mac/">Mac</a><small>1</small></li>
  
    <li><a href="/categories/Software/">Software</a><small>2</small></li>
  
    <li><a href="/categories/iOS/">iOS</a><small>34</small></li>
  
    <li><a href="/categories/just-talk/">just-talk</a><small>14</small></li>
  
    <li><a href="/categories/read book notes/">read book notes</a><small>2</small></li>
  
  </ul>
</div>


  

  
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2013 萧宸宇
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'iiiyu';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>