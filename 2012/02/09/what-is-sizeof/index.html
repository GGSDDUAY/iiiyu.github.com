

<article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2012-02-09T08:01:00.000Z"><a href="/2012/02/09/what-is-sizeof/">2月 9 2012</a></time>
      
      
  
    <h1 class="title">sizeof 深入理解</h1>
  

    </header>
    <div class="entry">
      
        <h1>sizeof 深入理解</h1>
<p>sizeof你们觉得是什么呢。函数？其实是操作符。
wiki解释</p>
<blockquote>
<p>In the programming languages C and C++, the unary operator &#39;sizeof&#39; is used to calculate the sizes of datatypes, in number of bytes. sizeof can be applied to all datatypes, be they primitive types such as the integer and floating-point types defined in the language, pointers to memory addresses, or the compound datatypes (unions, structs, or C++ classes) defined by the programmer. sizeof is an operator that returns the size in bytes of the type of the variable or parenthesized type-specifier that it precedes as a size_t type value.</p>
</blockquote>
<p>sizeof is an operator：sizeof是一个操作符。擦 这货居然是操作符。
最后一句我们可以得到的信息还有sizeof操作符的结果类型是size_t，它在头文件中typedef为unsigned　int类型。该类型保证能容纳实现所建立的最大对象的字节大小。</p>
<a name="more"></a>

<p>我们先记住什么时候可能用到sizeof,因为我们毕竟是学了用的.sizeof的应用场景一般是神马呢：</p>
<ul>
<li>sizeof操作符的一个主要用途是与存储分配和I/O系统那样的例程进行通信。例如：</li>
</ul>
<figure class="highlight lang-c"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre>void　<span class="variable">*malloc</span>(size_t　<span class="keyword">size</span>)
size_t　<span class="keyword">fread</span>(void　*　ptr,size_t　<span class="keyword">size</span>,size_t　nmemb,FILE　*　stream)
</pre></td></tr></table></figure>

<ul>
<li>用它可以看看一类型的对象在内存中所占的单元字节。</li>
</ul>
<figure class="highlight lang-c"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="keyword">void</span>　*　memset(<span class="keyword">void</span>　*　s,<span class="keyword">int</span>　c,<span class="keyword">sizeof</span>(s))
</pre></td></tr></table></figure>

<ul>
<li>在动态分配一对象时,可以让系统知道要分配多少内存。</li>
</ul>
<figure class="highlight lang-c"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="keyword">int</span> * pointer = malloc(<span class="keyword">sizeof</span>(<span class="keyword">int</span>) * <span class="number">10</span>)
</pre></td></tr></table></figure>

<ul>
<li><p>便于一些类型的扩充,在windows中就有很多结构内型就有一个专用的字段是用来放该类型的字节大小。</p>
</li>
<li><p>由于操作数的字节数在实现时可能出现变化，建议在涉及到操作数字节大小时用sizeof来代替常量计算。</p>
</li>
<li><p>如果操作数是函数中的数组形参或函数类型的形参，sizeof给出其指针的大小。</p>
</li>
</ul>
<p>知道怎么用以后我们来深入的蛋疼的讨论一下吧：
那我们考虑一下它既然是操作符那是一元的呢还是一元的呢还是一元的呢。。。。。。。。。。。。。</p>
<p>网上有人说sizeof是一元操作符，网上还有人说sizeof更像一个特殊的宏，它是在编译阶段求值的。
举个例子：</p>
<figure class="highlight lang-c"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="comment">#include &lt;stdio.h&gt;</span>
<span class="keyword">int</span> main()
{
    <span class="keyword">int</span> a = <span class="number">0</span>;
    <span class="keyword">printf</span>(<span class="string">"sizeof(a=3):<span class="variable">%d</span>\n"</span>,sizeof(a = <span class="number">3</span>));
    <span class="keyword">printf</span>(<span class="string">"a:<span class="variable">%d</span>\n"</span>,a);
    <span class="keyword">return</span> <span class="number">0</span>;
}
</pre></td></tr></table></figure>

<p>输出为什么是4，0而不是期望中的4，3？？？就在于sizeof在编译阶段处理的特性。由于sizeof不能被编译成机器码，所以sizeof作用范围内，也就是()里面的内容也不能被编译，而是被替换成类型。=操作符返回左操作数的类型，所以a=3相当于int，而代码也被替换为：</p>
<figure class="highlight lang-c"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="function"><span class="title">printf</span><span class="params">(<span class="string">"sizeof(a=3):%d\n"</span>,<span class="number">4</span>)</span>;
</pre></td></tr></table></figure>

<figure class="highlight lang-c"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="function"><span class="title">printf</span><span class="params">(<span class="string">"a:%d\n"</span>,a)</span>;
</pre></td></tr></table></figure>


<p>所以，sizeof是不可能支持链式表达式的，这也是和一元操作符不一样的地方。
结论：好，记住：sizeof 在 计算变量所占空间大小时， 括号可以省略， 而计算类型(模子)大小时不能省略。 一般情况下， 咱也别偷这个懒， 乖乖的写上括号， 继续装作一个 “函数” 做一个 ， “披着函数皮的操作符” 。 做我的操作符，让人家认为是函数去吧。 不要把sizeof当成函数，也不要看作一元操作符，把他当成一个特殊的编译预处理。</p>
<p>其实说到这里也差不多了，最后看一下几个比较飘逸的例子：</p>
<figure class="highlight lang-c"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="keyword">sizeof</span>（<span class="keyword">int</span>）*p 表示什么意思？
<span class="keyword">int</span> *p = <span class="literal">NULL</span>;
<span class="keyword">sizeof</span>(p)的值是多少？
<span class="keyword">sizeof</span>(*p)呢？
<span class="keyword">int</span> a[<span class="number">100</span>];
<span class="keyword">sizeof</span> (a) 的值是多少？
<span class="keyword">sizeof</span>(a[<span class="number">100</span>])呢？<span class="comment">//请尤其注意本例。</span>
<span class="keyword">sizeof</span>(&a)呢？
<span class="keyword">sizeof</span>(&a[<span class="number">0</span>])呢？
<span class="keyword">int</span> b[<span class="number">100</span>];
<span class="keyword">void</span> fun(<span class="keyword">int</span> b[<span class="number">100</span>])
{
<span class="keyword">sizeof</span>(b);<span class="comment">// sizeof (b) 的值是多少？</span>
}
</pre></td></tr></table></figure>

<p>时间不早了  1点多了 明天还要上班  睡了  结果自己看吧。</p>
<figure class="highlight lang-c"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="comment">#inlcude &lt;stdio.h&gt; </span>
void fun(<span class="keyword">int</span> b[<span class="number">100</span>])
{
    <span class="keyword">printf</span>(<span class="string">"fun()sizeof(b):<span class="variable">%d</span>\n"</span>,sizeof(b));
}
<span class="keyword">int</span> main()
{
    <span class="keyword">int</span> <span class="variable">*p</span> = NULL;
    <span class="keyword">int</span> a[<span class="number">100</span>];
    <span class="keyword">int</span> b[<span class="number">100</span>]; 
    <span class="keyword">printf</span>(<span class="string">"sizeof(p):<span class="variable">%d</span>\n"</span>,sizeof(p));
    <span class="keyword">printf</span>(<span class="string">"sizeof(<span class="variable">*p</span>):<span class="variable">%d</span>\n"</span>,sizeof(<span class="variable">*p</span>));
    <span class="keyword">printf</span>(<span class="string">"sizeof(a):<span class="variable">%d</span>\n"</span>,sizeof(a));
    <span class="keyword">printf</span>(<span class="string">"sizeof(a[100]):<span class="variable">%d</span>\n"</span>,sizeof(a[<span class="number">100</span>]));
    <span class="keyword">printf</span>(<span class="string">"sizeof(&a):<span class="variable">%d</span>\n"</span>,sizeof(&a));
    <span class="keyword">printf</span>(<span class="string">"sizeof(&a[0]):<span class="variable">%d</span>\n"</span>,sizeof(&a[<span class="number">0</span>]));
    fun(a);
    <span class="keyword">return</span> <span class="number">0</span>;
}
</pre></td></tr></table></figure>


      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/just-talk/">just-talk</a>
  </div>

        
  
  <div class="tags">
    
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="http://s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
