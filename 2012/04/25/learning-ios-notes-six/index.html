<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>iOS笔记 (6) | 萧宸宇</title>
  <meta name="author" content="萧宸宇">
  
  <meta name="description" content="fuck">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="iOS笔记 (6)"/>
  <meta property="og:site_name" content="萧宸宇"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="萧宸宇" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-29764460-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">萧宸宇</a></h1>
  <h2><a href="/">如果不能成为拯救世界的神，那就堕落到征服世界的魔吧。</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/about-me">关于我</a></li>
    
      <li><a href="/atom.xml">RSS</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2012-04-24T17:40:00.000Z"><a href="/2012/04/25/learning-ios-notes-six/">4月 25 2012</a></time>
      
      
  
    <h1 class="title">iOS笔记 (6)</h1>
  

    </header>
    <div class="entry">
      
        <h1>iOS笔记 利用ASIHTTPRequest做断点续传</h1>
<h2>主要问题</h2>
<p>需要请求Http协议，下载一个zip包。包比较大，希望能后台下载。退出应用再次打开的时候能接着上一次的下载。专业名称：断点续传。</p>
<h2>寻找方案</h2>
<p>iOS目前三大开源网络库</p>
<ul>
<li>ASIHTTPRequest</li>
<li>AFNetWorking</li>
<li>MKNetworkKit</li>
</ul>
<p>个人以Google出来的信息得出的对比：</p>
<p>| 网络库 | 优点 | 缺点 |</p>
<p>| —————— | ——————- | —————— |</p>
<p>| ASIHTTPRequest | 老牌、功能强大、文档丰富  | 停止更新、新特性少、厚重 |</p>
<p>| AFNetWorking | github上比较火的项目、有稳定的两个主要负责人、能支持比较新的特性、一直有更新  | 文档数目一般、有些功能貌似要自己写 |</p>
<p>| MKNetworkKit | 支持ARC、号称要有 ASIHTTPRequest的功能，AFNetWorking的轻便 | 文档数目最少、只有作者一个主要负责人 |</p>
<p>在结合我是一个新新手的缘由。如果用库的话，首选ASIHTTPRequest。<br>候选AFNetWorking。</p>
<p>AFNetWorking 被Google到<a href="https://github.com/AFNetworking/AFNetworking/pull/270" target="_blank">这样的解决方法</a>.本来准备fork了。然后仔细看了看下面的讨论。</p>
<p>觉得自己实现一个？ <a href="https://developer.apple.com/library/ios/#qa/qa1761/_index.html" target="_blank">原理在这里</a></p>
<p>sunmmer大神给了一个不用库<a href="https://developer.apple.com/library/ios/#qa/qa1761/_index.html" target="_blank">实现的例子</a></p>
<p>后面想了想，对于网络其实我也是新手来的。自己写，未必有成熟的库写的好。所以决定使用ASIHTTPRequest。</p>
<a id="more"></a>



<h2>ASIHTTPRequest</h2>
<p>我就简单说一下ASIHTTPRequest怎么使用到自己的项目当中。</p>
<p>下载ASIHTTPRequest以后。我们需要用到这些文件拖入我们的项目当中(记得copy打勾)</p>
<p><img src="http://farm8.staticflickr.com/7106/6963897920_837ba36cdd.jpg" alt="ios6-1"></p>
<p>然后我们需要导入</p>
<ul>
<li>CFNetwork.framework</li>
<li>SystemConfiguration.framework</li>
<li>MobileCoreServices.framework</li>
<li>CoreGraphics.framework</li>
<li>libz.dylib</li>
</ul>
<p>这些framework。<br>至此，我们已经可以很高兴快乐的使用ASIHTTPRequest了。</p>
<h2>断点续传</h2>
<h3>官方实现</h3>
<p><a href="http://allseeing-i.com/ASIHTTPRequest/How-to-use#resuming_interrupted_downloads" target="_blank">官方实例</a></p>
<h3>民间实现</h3>
<p>曹哥找了一个<a href="http://ryan.easymorse.com/?p=12" target="_blank">demo</a></p>
<p>ryan的这个demo对于我来说存在几个问题：</p>
<ul>
<li>关闭View controller以后无法保持下载(无法保持下载的状态)</li>
<li>无法跟踪多个UIProgressView</li>
</ul>
<p>等一些细小问题。</p>
<h3>我的实现</h3>
<p>我就在ryan这个demo的基础上改。</p>
<h4>下载持久化</h4>
<p>解决关闭View controller以后无法保持下载(无法保持下载的状态)这个问题。</p>
<p>我新定义了一个类。并且把这个类定义成单例，ASINetworkQueue作为这个单例的一个property。这样一来，就不怕view controller被pop掉，被关闭的时候，ASINetworkQueue被释放掉。</p>
<p>定义单例的技巧，可以说是一个模板。新建一个继承NSObject的类。<br>主要实现一个名叫shareXXXX的类方法。XXXX就是你类的名字。比如我的这个类叫TDNetworkQueue。就要实现一个</p>
<figure class="highlight lang-objc"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="literal">+</span> <span class="comment">(id)sharedTDNetworkQueue;
</pre></td></tr></table></figure>

<p>而sharexxxx方法可以参照一下模板。</p>
<figure class="highlight lang-objc"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre>+ (<span class="keyword">id</span>)sharedxxx
{
    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> pred;
    <span class="keyword">static</span> xxx *xx = <span class="literal">nil</span>;
    <span class="built_in">dispatch_once</span>(&pred, ^{ xx = [[<span class="keyword">self</span> alloc] init];});
    <span class="keyword">return</span> xx;
}
- (<span class="keyword">id</span>)init
{
    <span class="keyword">self</span> = [<span class="keyword">super</span> init];
    <span class="keyword">if</span> (<span class="keyword">self</span>) {       
    }
    <span class="keyword">return</span> <span class="keyword">self</span>;
}
- (<span class="keyword">void</span>)dealloc
{
    [<span class="keyword">super</span> dealloc];
}
</pre></td></tr></table></figure>

<p>如果有属性初始化的话都放到init方法里面。share方法用到了一些GCD和block的东西。照搬就好。</p>
<h4>保持进度条</h4>
<p>解决无法跟踪多个UIProgressView的问题。<br>为了跟踪到UIProgressView，我在单例的类里面实现了</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="comment">// 增加下载的request进入队列</span>
- (<span class="keyword">void</span>)addDownloadRequestInQueue:(<span class="built_in">NSURL</span> *)paramURL 
                     withTempPath:(<span class="built_in">NSString</span> *)paramTempPath 
                 withDownloadPath:(<span class="built_in">NSString</span> *)paramDownloadPath 
                 withProgressView:(UIProgressView *)paramProgressView;

<span class="comment">// 当controller被关闭清除内存的时候，设置到delegate的view要设置为nil</span>
- (<span class="keyword">void</span>)clearAllRequestsDelegate;

<span class="comment">// 当controller被关闭清除内存的时候，设置到delegate的view要设置为nil.只对一个有效果</span>
- (<span class="keyword">void</span>)clearOneRequestDelegateWithURL:(<span class="built_in">NSString</span> *)paramURL;

<span class="comment">// 恢复progressview的进度</span>
- (<span class="keyword">void</span>)requestsDelegateSettingWithDictonary:(<span class="built_in">NSDictionary</span> *) paramDictonary;
</pre></td></tr></table></figure>

<p>这些方法。<br>值得注意的是</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
</pre></td><td class="code"><pre><span class="pp">- <span class="params">(void)</span>addDownloadRequestInQueue:<span class="params">(<span class="variable">NSURL</span> *)</span>paramURL 
                     withTempPath:<span class="params">(<span class="variable">NSString</span> *)</span>paramTempPath 
                 withDownloadPath:<span class="params">(<span class="variable">NSString</span> *)</span>paramDownloadPath 
                 withProgressView:<span class="params">(<span class="variable">UIProgressView</span> *)</span>paramProgressView;
</pre></td></tr></table></figure>

<p>这里的paramProgressView对应于你的请求下载的URL(request)。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre><span class="comment">// 恢复progressview的进度</span>
- (<span class="keyword">void</span>)requestsDelegateSettingWithDictonary:(<span class="built_in">NSDictionary</span> *) paramDictonary;
</pre></td></tr></table></figure>

<p>这里的字典key是URL，object是UIProgressView。我在view controller中的viewDidLoad方法调用。</p>
<h2>总结</h2>
<p>我改写的很简单，特别的地方都在上面注明了。如果不明白就留言吧。大神们也请轻拍，我在慢慢努力中。</p>
<p>改写的github地址：</p>
<pre><code><span class="title">git</span> clone <span class="url">git://github.com/iiiyu/TestDownload.git</code></pre>
<p>最后附送两篇队列优先级的文章</p>
<p>[使用NSOperationQueue简化多线程开发]<br><a href="http://blog.colcy.com/archives/2011/217/11/25/使用nsoperationqueue简化多线程开发/" target="_blank">http://blog.colcy.com/archives/2011/217/11/25/使用nsoperationqueue简化多线程开发/</a></p>
<p>[队列的优先级]<br><a href="http://blog.colcy.com/archives/2011/222/11/25/队列的优先级/" target="_blank">http://blog.colcy.com/archives/2011/222/11/25/队列的优先级/</a></p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/iOS/">iOS</a>
  </div>

        
        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:iiiyu.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Emacs/">Emacs</a><small>3</small></li>
  
    <li><a href="/categories/Mac/">Mac</a><small>1</small></li>
  
    <li><a href="/categories/Software/">Software</a><small>2</small></li>
  
    <li><a href="/categories/iOS/">iOS</a><small>31</small></li>
  
    <li><a href="/categories/just-talk/">just-talk</a><small>13</small></li>
  
    <li><a href="/categories/read book notes/">read book notes</a><small>2</small></li>
  
  </ul>
</div>


  

  
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2013 萧宸宇
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'iiiyu';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>